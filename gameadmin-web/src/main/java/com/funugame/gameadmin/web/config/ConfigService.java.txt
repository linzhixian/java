/**
 * 
 */
package com.funugame.gameadmin.web.config;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.TimerTask;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpRequest;
import org.springframework.stereotype.Service;

import com.funugame.gameadmin.web.daoentity.DataCenterServer;
import com.funugame.gameadmin.web.daoentity.ParserConfigUtil;
import com.lzx.framework.server.IServer;
import com.lzx.framework.utils.file.CharSetConvertor;

/**
 * @author linzhixian 2014年10月24日下午2:39:34 classpath:conf/ 下 有： version.txt
 *         配置文件版本号，每当clientNeedFiles.txt自身及其里面的文件有改变都必须改变 clientNeedFiles.txt
 *         客户端需要的配置文件列表
 * 
 */

@Service("configService_RMI")
public class ConfigService extends TimerTask implements InitializingBean {
    protected static Logger logger = LoggerFactory.getLogger(ConfigService.class);

    private Map<String, RawFile> configFileMap = new HashMap<String, RawFile>();

    @Autowired
    private IServer server;

    private static String dataDir;

    @Override
    public void afterPropertiesSet() throws Exception {
	dataDir=this.getClass().getClassLoader().getResource("/").getPath()+"data";
	System.out.println(dataDir);
	loadAllRawFile();
    }

    @Override
    public void run() {
	try {
	    loadAllRawFile();
	} catch (IOException e) {
	    e.printStackTrace();
	}
    }

    private void loadAllRawFile() throws IOException {
	// load version file
	File dir = openFile("");
	 System.err.println(dir.getAbsolutePath());
	if (!dir.isDirectory()) {
	    System.err.println(dir.getParent() + " must a direction");
	    throw new IllegalArgumentException();
	}
	File[] files = dir.listFiles();
	for (File f : files) {
	    if (!f.isFile())
		continue;
	    String fileName = f.getName();
	    RawFile configFile = configFileMap.get(fileName);
	    if (configFile == null || configFile.isNew(f.lastModified())) {
		logger.info("load conf file:" + fileName);
		System.out.println("load conf file:" + fileName);
		configFile = new RawFile(f);
		configFileMap.put(fileName, configFile);
		ParserConfigUtil.parserConfigTxt(configFile);
	    }
	    // 不再使用，清除文件内容，释放内存
	    configFile.setContent(null);
	}
    }

    public static String loadConfigResource(String fileName) {
	File file = openFile(fileName);
	byte[] cBytes = CharSetConvertor.readFileToTypes(file);
	return CharSetConvertor.convertBytes(cBytes, fileName);
    }

    public static File openFile(String fileName) {
	return new File(dataDir + fileName);
    }
}